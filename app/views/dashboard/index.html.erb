<% content_for :page_title, "Dashboard" %>

<!-- Alerts with close buttons -->
<% if @low_stock_products.any? %>
  <div class="alert alert-warning" id="low-stock-alert" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <strong>‚ö†Ô∏è Low Stock Alert:</strong> <%= @low_stock_products.length %> products are below reorder point
    </div>
    <button onclick="dismissAlert('low-stock-alert')"
            style="background: none; border: none; cursor: pointer; font-size: 1.5rem; color: #744210; padding: 0 0.5rem;"
            aria-label="Close alert">
      √ó
    </button>
  </div>
<% end %>

<% if @out_of_stock_count > 0 %>
  <div class="alert alert-danger" id="out-of-stock-alert" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <strong>üö® Critical:</strong> <%= @out_of_stock_count %> products are out of stock
    </div>
    <button onclick="dismissAlert('out-of-stock-alert')"
            style="background: none; border: none; cursor: pointer; font-size: 1.5rem; color: #742a2a; padding: 0 0.5rem;"
            aria-label="Close alert">
      √ó
    </button>
  </div>
<% end %>

<!-- Stats Grid -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">Total Products</span>
    </div>
    <div class="stat-value"><%= number_with_delimiter(@total_products) %></div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">Total Value</span>
    </div>
    <div class="stat-value">$<%= number_with_delimiter(@total_value.round(2), delimiter: ',') %></div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">Low Stock Items</span>
    </div>
    <div class="stat-value"><%= @low_stock_products.length %></div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">Pending Orders</span>
    </div>
    <div class="stat-value"><%= @pending_orders %></div>
  </div>
</div>

<div class="grid-2">
  <!-- Recent Sales -->
  <div class="table-container">
    <div class="table-header">
      <h3 class="table-title">Recent Sales</h3>
      <% if can_make_sales? %>
        <%= link_to "View All", sales_path, class: "btn btn-secondary" %>
      <% end %>
    </div>
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Quantity</th>
          <th>Amount</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        <% if @recent_sales.any? %>
          <% @recent_sales.limit(5).each do |sale| %>
            <tr>
              <td><%= sale.product.name %></td>
              <td><%= sale.quantity %></td>
              <td>$<%= number_with_delimiter(sale.total_amount.round(2)) %></td>
              <td><%= time_ago_in_words(sale.transaction_date) %> ago</td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="4" style="text-align: center; color: #718096; font-style: italic;">
              No recent sales
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Low Stock Alerts -->
  <div class="table-container">
    <div class="table-header">
      <h3 class="table-title">Low Stock Alerts</h3>
      <%= link_to "View All", products_path, class: "btn btn-primary" %>
    </div>
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Current</th>
          <th>Reorder Point</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <% if @low_stock_products.any? %>
          <% @low_stock_products.each do |product| %>
            <tr>
              <td><%= link_to product.name, product_path(product) %></td>
              <td class="stock-low"><%= product.total_stock %></td>
              <td><%= product.reorder_point %></td>
              <td>
                <span class="badge <%= product.total_stock == 0 ? 'badge-danger' : 'badge-warning' %>">
                  <%= product.total_stock == 0 ? 'Critical' : 'Low' %>
                </span>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="4" style="text-align: center; color: #718096; font-style: italic;">
              All products are adequately stocked
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<script>
  function dismissAlert(alertId) {
    const alert = document.getElementById(alertId);
    if (alert) {
      alert.style.transition = 'opacity 0.3s ease-out';
      alert.style.opacity = '0';
      setTimeout(() => {
        alert.style.display = 'none';
      }, 300);
    }
  }
</script>