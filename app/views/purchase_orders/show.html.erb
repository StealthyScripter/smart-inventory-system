<% content_for :page_title, "Purchase Order #{@purchase_order.order_number}" %>

<div class="table-container">
  <div class="table-header">
    <h3 class="table-title">Purchase Order #<%= @purchase_order.order_number %></h3>
    <div style="display: flex; gap: 1rem;">
      <% if @purchase_order.pending? %>
        <%= link_to "Edit", edit_purchase_order_path(@purchase_order), class: "btn btn-secondary" %>
        <%= button_to "Mark as Sent", mark_as_sent_purchase_order_path(@purchase_order),
                      method: :patch,
                      form: { data: { turbo_confirm: "Mark this order as sent to supplier?" } },
                      class: "btn btn-primary" %>
      <% elsif @purchase_order.ordered? %>
        <%= button_to "Mark as Received", mark_as_received_purchase_order_path(@purchase_order),
                      method: :patch,
                      form: { data: { turbo_confirm: "Mark as received? This will update stock levels." } },
                      class: "btn btn-success" %>
      <% end %>
      <%= link_to "Back to Orders", purchase_orders_path, class: "btn btn-secondary" %>
    </div>
  </div>

  <div style="padding: 2rem;">
    <!-- Order Status Banner -->
    <div class="alert alert-<%= @purchase_order.status == 'pending' ? 'warning' : @purchase_order.status == 'ordered' ? 'info' : 'success' %>" style="margin-bottom: 2rem;">
      <strong>Status:</strong> <%= @purchase_order.status.titleize %>
    </div>

    <!-- Order Information -->
    <div class="grid-2" style="gap: 2rem; margin-bottom: 2rem;">
      <div>
        <h4 style="margin-bottom: 1rem;">Order Information</h4>
        <p><strong>Order Number:</strong> <%= @purchase_order.order_number %></p>
        <p><strong>Supplier:</strong> <%= link_to @purchase_order.supplier.name, supplier_path(@purchase_order.supplier) %></p>
        <p><strong>Created by:</strong> <%= @purchase_order.user.full_name %></p>
        <p><strong>Order Date:</strong> <%= @purchase_order.order_date.strftime("%B %d, %Y") %></p>
        <p><strong>Expected Delivery:</strong> <%= @purchase_order.expected_delivery_date&.strftime("%B %d, %Y") || "TBD" %></p>
      </div>

      <div>
        <h4 style="margin-bottom: 1rem;">Order Summary</h4>
        <p><strong>Total Items:</strong> <%= @purchase_order_items.sum(:quantity) %></p>
        <p><strong>Unique Products:</strong> <%= @purchase_order_items.count %></p>
        <p style="font-size: 1.25rem; margin-top: 1rem;">
          <strong>Total Amount:</strong>
          <span style="color: #2d3748; font-weight: 700;">
            $<%= number_with_delimiter(@purchase_order.total_amount.round(2)) %>
          </span>
        </p>
      </div>
    </div>

    <!-- Order Items -->
    <div style="margin-top: 2rem;">
      <h4 style="margin-bottom: 1rem;">Order Items</h4>
      <table>
        <thead>
          <tr>
            <th>Product</th>
            <th>SKU</th>
            <th>Quantity</th>
            <th>Unit Cost</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <% @purchase_order_items.each do |item| %>
            <tr>
              <td><%= link_to item.product.name, product_path(item.product) %></td>
              <td><%= item.product.sku %></td>
              <td><%= item.quantity %></td>
              <td>$<%= number_with_delimiter(item.unit_cost.round(2)) %></td>
              <td>$<%= number_with_delimiter(item.total_cost.round(2)) %></td>
            </tr>
          <% end %>
        </tbody>
        <tfoot>
          <tr style="font-weight: 700; background: #f7fafc;">
            <td colspan="2">Total</td>
            <td><%= @purchase_order_items.sum(:quantity) %></td>
            <td></td>
            <td>$<%= number_with_delimiter(@purchase_order.total_amount.round(2)) %></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Actions -->
    <div style="margin-top: 2rem; display: flex; gap: 1rem;">
      <% if @purchase_order.pending? %>
        <%= link_to "Edit Order", edit_purchase_order_path(@purchase_order), class: "btn btn-primary" %>
        <%= button_to "Delete Order", @purchase_order,
                      method: :delete,
                      form: { data: { turbo_confirm: "Are you sure you want to delete this order?" } },
                      class: "btn btn-danger" %>
      <% end %>
      <%= link_to "Print Order", "#", class: "btn btn-secondary", onclick: "window.print(); return false;" %>
    </div>
  </div>
</div>

<style media="print">
  .table-header .btn, nav, .sidebar, .alert {
    display: none !important;
  }
</style>