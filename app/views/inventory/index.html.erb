<% content_for :page_title, "Inventory Management" %>

<!-- User Scope Indicator -->
<div style="margin-bottom: 1rem;">
  <%= user_scope_indicator %>
</div>

<div class="grid-2">
  <div>
    <h3 style="margin-bottom: 1rem;">Stock Levels by Location</h3>
    <div class="form-group">
      <select class="form-select" id="location-filter">
        <option value="">All Locations</option>
        <% @locations.each do |location| %>
          <option value="<%= location.id %>" <%= 'selected' if (supervisor? || employee?) && location == current_user.location %>>
            <%= location.name %>
            <% if (supervisor? || employee?) && location == current_user.location %>
              (Your Location)
            <% end %>
          </option>
        <% end %>
      </select>
    </div>
  </div>
  <div style="text-align: right;">
    <% if can_edit? %>
      <%= link_to "Stock Adjustment", "#", class: "btn btn-secondary",
                  onclick: "alert('Stock Adjustment feature coming soon!'); return false;" %>
    <% else %>
      <span class="btn btn-secondary" style="opacity: 0.5; cursor: not-allowed;"
            title="<%= permission_message(:edit) %>">
        Stock Adjustment
      </span>
    <% end %>
  </div>
</div>

<div class="table-container">
  <div class="table-header">
    <h3 class="table-title">Current Stock Levels</h3>
    <% if can_create? %>
      <%= link_to "Add Product", new_product_path, class: "btn btn-primary" %>
    <% end %>
  </div>
  <table>
    <thead>
      <tr>
        <th>Product</th>
        <th>Location</th>
        <th>Current Stock</th>
        <th>Reserved</th>
        <th>Available</th>
        <th>Value</th>
        <th>Status</th>
        <% if can_edit? %>
          <th>Actions</th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% @stock_levels.each do |stock_level| %>
        <tr data-location-id="<%= stock_level.location_id %>"
            class="stock-row <%= 'user-location' if (supervisor? || employee?) && stock_level.location == current_user.location %>">
          <td>
            <%= link_to stock_level.product.name, product_path(stock_level.product) %>
            <% if stock_level.current_quantity < stock_level.product.reorder_point %>
              <span style="color: #e53e3e; font-size: 0.875rem;"> ⚠️</span>
            <% end %>
          </td>
          <td>
            <%= location_with_access(stock_level.location) %>
          </td>
          <td>
            <span class="<%= stock_level.current_quantity < stock_level.product.reorder_point ? 'stock-low' : '' %>">
              <%= stock_level.current_quantity %>
            </span>
          </td>
          <td><%= stock_level.reserved_quantity %></td>
          <td>
            <strong><%= stock_level.available_quantity %></strong>
          </td>
          <td>
            <%= currency(stock_level.current_quantity * stock_level.product.unit_cost) %>
          </td>
          <td>
            <%= stock_status_badge(stock_level.product, stock_level.location) %>
          </td>
          <% if can_edit? %>
            <td>
              <% if can_operate_in_location?(stock_level.location) %>
                <button class="btn btn-secondary"
                        style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"
                        onclick="adjustStock(<%= stock_level.product.id %>, <%= stock_level.location.id %>, <%= stock_level.current_quantity %>)">
                  Adjust
                </button>
              <% else %>
                <span style="color: #718096; font-size: 0.875rem;">View Only</span>
              <% end %>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
    <tfoot>
      <tr style="font-weight: 700; background: #f7fafc;">
        <td colspan="2">Total Value</td>
        <td><%= @stock_levels.sum(:current_quantity) %></td>
        <td><%= @stock_levels.sum(:reserved_quantity) %></td>
        <td><%= @stock_levels.sum { |sl| sl.current_quantity - sl.reserved_quantity } %></td>
        <td>
          <%= currency(@stock_levels.sum { |sl| sl.current_quantity * sl.product.unit_cost }) %>
        </td>
        <td colspan="<%= can_edit? ? 2 : 1 %>"></td>
      </tr>
    </tfoot>
  </table>
</div>

<!-- Stock Adjustment Modal (if user has edit permission) -->
<% if can_edit? %>
  <div id="adjust-stock-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 0.5rem; max-width: 400px; width: 90%;">
      <h3 style="margin-bottom: 1rem;">Adjust Stock Level</h3>

      <%= form_with url: inventory_adjust_path, method: :post, id: "adjust-stock-form" do |f| %>
        <%= f.hidden_field :product_id, id: "adjust_product_id" %>
        <%= f.hidden_field :location_id, id: "adjust_location_id" %>

        <div class="form-group">
          <label class="form-label">Current Quantity</label>
          <input type="number" id="adjust_current_quantity" class="form-input" readonly style="background: #f7fafc;">
        </div>

        <div class="form-group">
          <%= f.label :quantity, "New Quantity", class: "form-label" %>
          <%= f.number_field :quantity, min: 0, class: "form-input", required: true, id: "adjust_new_quantity" %>
        </div>

        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
          <%= f.submit "Update Stock", class: "btn btn-primary" %>
          <button type="button" onclick="closeAdjustModal()" class="btn btn-secondary">Cancel</button>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<style>
  .scope-indicator {
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-weight: 500;
    display: inline-block;
    font-size: 0.875rem;
  }

  .scope-all {
    background: #c6f6d5;
    color: #22543d;
    border: 1px solid #9ae6b4;
  }

  .scope-single {
    background: #bee3f8;
    color: #2a4365;
    border: 1px solid #90cdf4;
  }

  .scope-readonly {
    background: #e2e8f0;
    color: #4a5568;
    border: 1px solid #cbd5e0;
  }

  .user-location {
    background: #f7fafc;
  }

  .location-accessible {
    font-weight: 600;
  }

  .location-view-only {
    color: #718096;
  }
</style>

<script>
  // Location filter
  document.getElementById('location-filter')?.addEventListener('change', function() {
    const locationId = this.value;
    const rows = document.querySelectorAll('.stock-row');

    rows.forEach(row => {
      if (locationId === '' || row.dataset.locationId === locationId) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });

  <% if can_edit? %>
  // Stock adjustment modal
  function adjustStock(productId, locationId, currentQuantity) {
    document.getElementById('adjust_product_id').value = productId;
    document.getElementById('adjust_location_id').value = locationId;
    document.getElementById('adjust_current_quantity').value = currentQuantity;
    document.getElementById('adjust_new_quantity').value = currentQuantity;

    const modal = document.getElementById('adjust-stock-modal');
    modal.style.display = 'flex';
  }

  function closeAdjustModal() {
    document.getElementById('adjust-stock-modal').style.display = 'none';
  }

  // Close modal on outside click
  document.getElementById('adjust-stock-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      closeAdjustModal();
    }
  });
  <% end %>
</script>