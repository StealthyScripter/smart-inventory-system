<% content_for :page_title, "Sale ##{@sale.id}" %>

<div class="table-container">
  <div class="table-header">
    <h3 class="table-title">Sale Details - #<%= @sale.id %></h3>
    <div style="display: flex; gap: 1rem;">
      <%= link_to "Back to Sales", sales_path, class: "btn btn-secondary" %>
      <%= link_to "Cancel Sale", sale_path(@sale), method: :delete,
                  confirm: "Are you sure? This will restore the inventory and cannot be undone.",
                  class: "btn btn-danger" %>
    </div>
  </div>

  <div style="padding: 2rem;">
    <div class="grid-2" style="gap: 2rem;">
      <div>
        <h4 style="margin-bottom: 1rem;">Transaction Information</h4>

        <div style="margin-bottom: 1rem;">
          <strong>Transaction Date:</strong><br>
          <%= @sale.transaction_date.strftime("%B %d, %Y at %I:%M %p") %>
        </div>

        <div style="margin-bottom: 1rem;">
          <strong>Product:</strong><br>
          <%= link_to @sale.product.name, product_path(@sale.product),
                      style: "color: #3182ce; text-decoration: underline;" %>
          <br>
          <small style="color: #718096;">SKU: <%= @sale.product.sku %></small>
        </div>

        <div style="margin-bottom: 1rem;">
          <strong>Location:</strong><br>
          <%= link_to @sale.location.name, location_path(@sale.location),
                      style: "color: #3182ce; text-decoration: underline;" %>
        </div>

        <div style="margin-bottom: 1rem;">
          <strong>Sales Representative:</strong><br>
          <%= @sale.user.full_name %>
          <br>
          <small style="color: #718096;"><%= @sale.user.email %></small>
        </div>

        <div style="margin-bottom: 1rem;">
          <strong>Customer:</strong><br>
          <%= @sale.customer_name || "Walk-in Customer" %>
        </div>
      </div>

      <div>
        <h4 style="margin-bottom: 1rem;">Sale Details</h4>

        <div style="margin-bottom: 1rem;">
          <strong>Quantity Sold:</strong><br>
          <span style="font-size: 1.25rem; color: #2d3748;"><%= @sale.quantity %> units</span>
        </div>

        <div style="margin-bottom: 1rem;">
          <strong>Unit Price:</strong><br>
          <span style="font-size: 1.25rem; color: #2d3748;">$<%= number_with_precision(@sale.unit_price, precision: 2) %></span>
        </div>

        <div style="margin-bottom: 1rem;">
          <strong>Total Amount:</strong><br>
          <span style="font-size: 1.5rem; font-weight: 700; color: #38a169;">
            $<%= number_with_precision(@sale.total_amount, precision: 2) %>
          </span>
        </div>

        <!-- Current Stock Information -->
        <div style="margin-top: 2rem; padding: 1rem; background: #f7fafc; border-radius: 0.375rem;">
          <h5 style="margin-bottom: 0.5rem;">Current Stock at <%= @sale.location.name %></h5>
          <% stock_level = @sale.product.stock_levels.find_by(location: @sale.location) %>
          <% if stock_level %>
            <p style="color: #4a5568; font-size: 0.875rem; margin-bottom: 0.25rem;">
              <strong>Available:</strong> <%= stock_level.available_quantity %> units
            </p>
            <p style="color: #4a5568; font-size: 0.875rem; margin-bottom: 0.25rem;">
              <strong>Total Stock:</strong> <%= stock_level.current_quantity %> units
            </p>
            <p style="color: #4a5568; font-size: 0.875rem;">
              <strong>Reserved:</strong> <%= stock_level.reserved_quantity %> units
            </p>
          <% else %>
            <p style="color: #e53e3e; font-size: 0.875rem;">No stock information available</p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Stock Movements Related to This Sale -->
    <div style="margin-top: 2rem;">
      <h4 style="margin-bottom: 1rem;">Related Stock Movements</h4>

      <% movements = StockMovement.where(reference: @sale) %>
      <% if movements.any? %>
        <table style="margin-top: 1rem;">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Quantity</th>
              <th>User</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            <% movements.each do |movement| %>
              <tr>
                <td><%= movement.movement_date.strftime("%m/%d/%Y %I:%M %p") %></td>
                <td>
                  <span class="badge badge-<%= movement.movement_type == 'sale' ? 'warning' : 'info' %>">
                    <%= movement.movement_type.titleize %>
                  </span>
                </td>
                <td><%= movement.quantity %></td>
                <td><%= movement.user.full_name %></td>
                <td><%= movement.notes %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p style="color: #718096; font-style: italic;">No stock movements found for this sale.</p>
      <% end %>
    </div>

    <!-- Action Buttons -->
    <div style="margin-top: 2rem; display: flex; gap: 1rem; align-items: center;">
      <%= link_to "Print Receipt", "#", class: "btn btn-secondary",
                  onclick: "window.print(); return false;" %>
      <%= link_to "New Sale", new_sale_path, class: "btn btn-primary" %>
      <%= link_to "Cancel This Sale", sale_path(@sale), method: :delete,
                  confirm: "Are you sure? This will restore #{@sale.quantity} units to inventory and cannot be undone.",
                  class: "btn btn-danger" %>
    </div>
  </div>
</div>

<style media="print">
  .table-header, .btn, nav, .sidebar {
    display: none !important;
  }

  .table-container {
    box-shadow: none !important;
    margin: 0 !important;
  }

  body {
    background: white !important;
  }
</style>